<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多二维码扫描Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* ... 样式部分没有改变 ... */
        video { z-index: -1; }
        .qr-box {
            position: absolute;
            border: 3px solid #00FF00;
            background-color: rgba(0, 255, 0, 0.1);
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 10;
        }
        .qr-box:hover { background-color: rgba(0, 255, 0, 0.3); }
        body { overflow: hidden; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex flex-col items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-2xl mx-auto">
        <h1 class="text-2xl font-bold text-center mb-4">多二维码扫描</h1>
        
        <div id="scanner-container" class="relative w-full aspect-square bg-gray-800 rounded-lg overflow-hidden shadow-lg mx-auto">
            <video id="video" playsinline autoplay muted class="w-full h-full object-cover"></video>
            <div id="overlay" class="absolute top-0 left-0 w-full h-full"></div>
        </div>
        
        <div id="controls" class="text-center mt-4">
            <button id="start-scan-btn" class="w-full max-w-xs bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded transition text-lg">
                开始扫描
            </button>
            <p id="status" class="text-center text-gray-400 mt-4 hidden">请点击开始扫描</p>
        </div>
    </div>

    <!-- 结果显示模态框 -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-semibold mb-4">扫描结果</h3>
            <div id="modal-content" class="bg-gray-700 p-3 rounded text-sm break-words max-h-40 overflow-y-auto">
            </div>
            <button id="close-modal" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded transition">
                关闭
            </button>
        </div>
    </div>


    <!-- 
      【重大修复】
      我们把代码分成了两个脚本。
    -->
    
    <script>
        // 【脚本 1：只管摄像头】
        // 这是一个普通的脚本，它不依赖任何外部库，保证能运行。
        // 它的唯一职责：响应点击，打开摄像头。
        window.isCameraReady = false; // 全局标志

        window.addEventListener('load', () => {
            const video = document.getElementById('video');
            const statusEl = document.getElementById('status');
            const startScanBtn = document.getElementById('start-scan-btn');

            statusEl.classList.remove('hidden'); // 显示状态

            // 把摄像头启动逻辑单独放在一个函数里
            async function startCameraOnly() {
                statusEl.textContent = '正在请求摄像头权限...';
                
                try {
                    const constraints = { video: { facingMode: 'environment' }, audio: false };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    
                    video.onplaying = () => {
                        statusEl.textContent = '摄像头已启动，正在加载扫描库...';
                        // 摄像头成功启动！
                        // 现在通知“脚本2”可以开始工作了
                        window.isCameraReady = true; 
                    };

                } catch (err) {
                    console.error("摄像头启动失败:", err);
                    if (err.name === 'NotAllowedError') {
                        statusEl.textContent = '错误：用户拒绝了摄像头权限。';
                    } else if (err.name === 'NotFoundError' || err.name === 'OverconstrainedError') {
                        statusEl.textContent = '错误：找不到后置摄像头。';
                    } else {
                        statusEl.textContent = `错误：摄像头启动失败 (${err.name})。`;
                    }
                    startScanBtn.classList.remove('hidden'); // 允许用户重试
                }
            }

            // 按钮点击事件，这个监听器现在100%会添加成功
            startScanBtn.addEventListener('click', () => {
                startScanBtn.classList.add('hidden');
                startCameraOnly(); // 调用只管摄像头的函数
            });
        });
    </script>
    
    <script type="module">
        // 【脚本 2：只管扫描】
        // 这是一个模块脚本，它会加载外部库。
        // 它只在摄像头成功启动后 (window.isCameraReady == true) 才开始扫描。

        import { 
            BrowserMultiFormatReader, 
            NotFoundException 
        } from 'https://unpkg.com/@zxing/library@0.21.0/esm/index.js';

        // 假设库加载成功...
        const codeReader = new BrowserMultiFormatReader();
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal');
        const statusEl = document.getElementById('status'); // 获取状态元素

        function showModal(title, text) {
            modalTitle.textContent = title;
            modalContent.textContent = text;
            modal.classList.remove('hidden');
        }

        closeModalBtn.onclick = () => {
            modal.classList.add('hidden');
        };
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        };

        function drawOverlays(results) {
            overlay.innerHTML = '';
            const videoRect = video.getBoundingClientRect();
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            
            if (!videoWidth || !videoHeight) return;

            const scaleX = videoRect.width / videoWidth;
            const scaleY = videoRect.height / videoHeight;

            results.forEach(result => {
                const points = result.resultPoints;
                const minX = Math.min(...points.map(p => p.x));
                const minY = Math.min(...points.map(p => p.y));
                const maxX = Math.max(...points.map(p => p.x));
                const maxY = Math.max(...points.map(p => p.y));
                
                const left = minX * scaleX;
                const top = minY * scaleY;
                const width = (maxX - minX) * scaleX;
                const height = (maxY - minY) * scaleY;

                const box = document.createElement('div');
                box.className = 'qr-box';
                box.style.left = `${left}px`;
                box.style.top = `${top}px`;
                box.style.width = `${width}px`;
                box.style.height = `${height}px`;

                const text = result.getText();
                box.onclick = (e) => {
                    e.stopPropagation();
                    showModal('扫描结果', text);
                };
                
                overlay.appendChild(box);
            });
        }

        async function scanFrame() {
            if (video.readyState < video.HAVE_CURRENT_DATA) {
                return; 
            }
            
            try {
                const results = await codeReader.decodeMultipleFromVideoElement(video);
                drawOverlays(results);
                
            } catch (err) {
                if (err instanceof NotFoundException) {
                    drawOverlays([]); 
                } else {
                    // 忽略
                }
            }
        }

        // 设置一个定时器，不断检查摄像头是否准备就绪
        const scanInterval = setInterval(() => {
            if (window.isCameraReady) {
                // 摄像头好了！
                // 停止这个检查定时器
                clearInterval(scanInterval);
                
                // 更新状态
                statusEl.textContent = '扫描库加载成功，请对准二维码。';
                
                // 真正开始循环扫描
                setInterval(scanFrame, 300);
            }
        }, 200); // 每 200ms 检查一次

    </script>
</body>
</html>

