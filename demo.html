<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多二维码扫描Demo</title>
    <!-- 引入 Tailwind CSS 框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 
      加载本地扫描库 (v0.20.0)
      确保 index.min.js 和此 html 文件在同一目录
    -->
    <script src="./index.min.js"></script>
    
    <style>
        video { z-index: -1; }
        /* .qr-box 是扫描框的样式 */
        .qr-box {
            position: absolute;
            border: 3px solid #00FF00;
            background-color: rgba(0, 255, 0, 0.1);
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 10;
        }
        .qr-box:hover { background-color: rgba(0, 255, 0, 0.3); }
        body { overflow: hidden; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex flex-col items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-2xl mx-auto">
        <h1 class="text-2xl font-bold text-center mb-4">多二维码扫描</h1>
        
        <div id="scanner-container" class="relative w-full aspect-square bg-gray-800 rounded-lg overflow-hidden shadow-lg mx-auto">
            <!-- 摄像头画面 -->
            <video id="video" playsinline autoplay muted class="w-full h-full object-cover"></video>
            <!-- 绿色框框会画在这一层 -->
            <div id="overlay" class="absolute top-0 left-0 w-full h-full"></div>
        </div>
        
        <div id="controls" class="text-center mt-4">
            <button id="start-scan-btn" class="w-full max-w-xs bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded transition text-lg">
                开始扫描
            </button>
            <p id="status" class="text-center text-gray-400 mt-4 hidden">请点击开始扫描</p>
        </div>
    </div>

    <!-- 结果弹窗 -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-semibold mb-4">扫描结果</h3>
            <div id="modal-content" class="bg-gray-700 p-3 rounded text-sm break-words max-h-40 overflow-y-auto">
            </div>
            <button id="close-modal" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded transition">
                关闭
            </button>
        </div>
    </div>

    
    <script>
        // 脚本 1：摄像头处理

        // 全局标志, 用于同步脚本 1 和 2
        window.isCameraReady = false; 

        window.addEventListener('load', () => {
            const video = document.getElementById('video');
            const statusEl = document.getElementById('status');
            const startScanBtn = document.getElementById('start-scan-btn');

            statusEl.classList.remove('hidden'); 

            // 请求并启动摄像头
            async function startCameraOnly() {
                statusEl.textContent = '正在请求摄像头权限...';
                
                try {
                    const constraints = { video: { facingMode: 'environment' }, audio: false };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    
                    // 监听 'onplaying' 事件, 确保视频已开始播放
                    video.onplaying = () => {
                        statusEl.textContent = '摄像头已启动，正在加载扫描库...';
                        window.isCameraReady = true; // 设置标志, 通知脚本 2
                    };

                } catch (err) {
                    console.error("摄像头启动失败:", err);
                    if (err.name === 'NotAllowedError') {
                        statusEl.textContent = '错误：用户拒绝了摄像头权限。';
                    } else if (err.name === 'NotFoundError' || err.name === 'OverconstrainedError') {
                        statusEl.textContent = '错误：找不到后置摄像头。';
                    } else {
                        statusEl.textContent = `错误：摄像头启动失败 (${err.name})。`;
                    }
                    startScanBtn.classList.remove('hidden'); // 出现错误, 显示按钮以允许重试
                }
            }

            // 绑定“开始扫描”按钮事件
            startScanBtn.addEventListener('click', () => {
                startScanBtn.classList.add('hidden'); // 点击后隐藏按钮
                startCameraOnly();
            });
        });
    </script>
    
    <script>
        // 脚本 2：扫描逻辑

        // 轮询检查摄像头是否就绪
        const scanInterval = setInterval(() => {
            if (window.isCameraReady) {
                // 摄像头就绪, 停止轮询
                clearInterval(scanInterval);
                const statusEl = document.getElementById('status'); 

                // 检查 ZXing 库是否加载成功
                if (typeof ZXing === 'undefined') {
                    statusEl.textContent = '错误：扫描库(index.min.js)加载失败！';
                    return;
                }

                // 从 ZXing 获取所需类
                const { 
                    BrowserMultiFormatReader, 
                    NotFoundException 
                } = ZXing;

                const codeReader = new BrowserMultiFormatReader();
                const video = document.getElementById('video');
                const overlay = document.getElementById('overlay');
                const modal = document.getElementById('modal');
                const modalTitle = document.getElementById('modal-title');
                const modalContent = document.getElementById('modal-content');
                const closeModalBtn = document.getElementById('close-modal');

                // 显示模态框
                function showModal(title, text) {
                    modalTitle.textContent = title;
                    modalContent.textContent = text;
                    modal.classList.remove('hidden');
                }

                // 关闭模态框
                closeModalBtn.onclick = () => {
                    modal.classList.add('hidden');
                };
                modal.onclick = (e) => { // 点击遮罩层关闭
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                };

                // 绘制边框
                function drawOverlays(results) {
                    overlay.innerHTML = '';
                    const videoRect = video.getBoundingClientRect(); // 视频在屏幕上的 CSS 尺寸
                    const videoWidth = video.videoWidth; // 视频的原始分辨率
                    const videoHeight = video.videoHeight;
                    
                    if (!videoWidth || !videoHeight) return;

                    // 计算视频源和显示尺寸的缩放比例
                    const scaleX = videoRect.width / videoWidth;
                    const scaleY = videoRect.height / videoHeight;

                    results.forEach(result => {
                        const points = result.resultPoints;
                        // 获取二维码四个角的坐标
                        const minX = Math.min(...points.map(p => p.x));
                        const minY = Math.min(...points.map(p => p.y));
                        const maxX = Math.max(...points.map(p => p.x));
                        const maxY = Math.max(...points.map(p => p.y));
                        
                        // 应用缩放比例, 转换为屏幕坐标
                        const left = minX * scaleX;
                        const top = minY * scaleY;
                        const width = (maxX - minX) * scaleX;
                        const height = (maxY - minY) * scaleY;

                        const box = document.createElement('div');
                        box.className = 'qr-box';
                        box.style.left = `${left}px`;
                        box.style.top = `${top}px`;
                        box.style.width = `${width}px`;
                        box.style.height = `${height}px`;

                        const text = result.getText();
                        // 边框的点击事件
                        box.onclick = (e) => {
                            e.stopPropagation(); // 阻止事件冒泡
                            showModal('扫描结果', text);
                        };
                        
                        overlay.appendChild(box);
                    });
                }

                // 扫描帧函数
                async function scanFrame() {
                    if (video.readyState < video.HAVE_CURRENT_DATA) {
                        return; 
                    }
                    
                    try {
                        // 核心: 使用 decodeMultiple 识别多个码
                        const results = await codeReader.decodeMultipleFromVideoElement(video);
                        drawOverlays(results);
                        
                    } catch (err) {
                        if (err instanceof NotFoundException) {
                            // 未找到码, 清除旧边框
                            drawOverlays([]); 
                        } else {
                            // 忽略其他错误
                        }
                    }
                }
                
                statusEl.textContent = '扫描库加载成功，请对准二维码。';
                // 节流: 每 300ms 扫描一次以降低CPU占用
                setInterval(scanFrame, 300);
            }
        }, 200); 
    </script>
</body>
</html>


