<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多二维码扫描Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 
    在下面的 <script type="module"> 标签中直接导入 (import) 这个库。
    -->
    
    <style>
        /* 强制视频在最底层 */
        video {
            z-index: -1;
        }
        /* 识别框样式 */
        .qr-box {
            position: absolute;
            border: 3px solid #00FF00;
            background-color: rgba(0, 255, 0, 0.1);
            box-sizing: border-box;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 10;
        }
        .qr-box:hover {
            background-color: rgba(0, 255, 0, 0.3);
        }
        /* 隐藏页面滚动条 */
        body {
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex flex-col items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-2xl mx-auto">
        <h1 class="text-2xl font-bold text-center mb-4">多二维码扫描</h1>
        
        <div id="scanner-container" class="relative w-full aspect-square bg-gray-800 rounded-lg overflow-hidden shadow-lg mx-auto">
            <video id="video" playsinline autoplay muted class="w-full h-full object-cover"></video>
            <div id="overlay" class="absolute top-0 left-0 w-full h-full"></div>
        </div>
        
        <p id="status" class="text-center text-gray-400 mt-4">正在请求摄像头权限...</p>
    </div>

    <!-- 结果显示模态框 -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-semibold mb-4">扫描结果</h3>
            <div id="modal-content" class="bg-gray-700 p-3 rounded text-sm break-words max-h-40 overflow-y-auto">
            </div>
            <button id="close-modal" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded transition">
                关闭
            </button>
        </div>
    </div>


    <!-- 
      【重大修改】
      我们使用 type="module"，这允许我们使用 import 语法。
    -->
    <script type="module">
    
        // 【重大修改】
        // 我们从一个稳定的 CDN 直接导入库的最新版本。
        // 这取代了所有旧的 <script src="..."> 标签和本地文件。
        import { 
            BrowserMultiFormatReader, 
            NotFoundException 
        } from 'https://cdn.jsdelivr.net/npm/@zxing/library@latest/esm/index.js';


        // --- 剩下的代码和原来一样，但现在能保证库已加载 ---

        window.addEventListener('load', () => {

            const video = document.getElementById('video');
            const overlay = document.getElementById('overlay');
            const statusEl = document.getElementById('status');
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const closeModalBtn = document.getElementById('close-modal');
            
            // 我们不再需要检查 typeof ZXing，因为 import 成功就意味着库已加载。
            // 如果 import 失败，会在控制台看到一个模块加载错误。

            const codeReader = new BrowserMultiFormatReader();

            /**
             * 显示模态框 (用于显示结果或错误)
             */
            function showModal(title, text) {
                modalTitle.textContent = title;
                modalContent.textContent = text;
                modal.classList.remove('hidden');
            }

            /**
             * 关闭模态框
             */
            closeModalBtn.onclick = () => {
                modal.classList.add('hidden');
            };
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            };

            /**
             * 在视频上绘制边框
             */
            function drawOverlays(results) {
                overlay.innerHTML = '';

                const videoRect = video.getBoundingClientRect();
                const videoWidth = video.videoWidth;
                const videoHeight = video.videoHeight;
                
                if (!videoWidth || !videoHeight) return;

                const scaleX = videoRect.width / videoWidth;
                const scaleY = videoRect.height / videoHeight;

                results.forEach(result => {
                    const points = result.resultPoints;

                    const minX = Math.min(...points.map(p => p.x));
                    const minY = Math.min(...points.map(p => p.y));
                    const maxX = Math.max(...points.map(p => p.x));
                    const maxY = Math.max(...points.map(p => p.y));
                    
                    const left = minX * scaleX;
                    const top = minY * scaleY;
                    const width = (maxX - minX) * scaleX;
                    const height = (maxY - minY) * scaleY;

                    const box = document.createElement('div');
                    box.className = 'qr-box';
                    box.style.left = `${left}px`;
                    box.style.top = `${top}px`;
                    box.style.width = `${width}px`;
                    box.style.height = `${height}px`;

                    const text = result.getText();
                    box.onclick = (e) => {
                        e.stopPropagation(); // 防止点击穿透
                        showModal('扫描结果', text);
                    };
                    
                    overlay.appendChild(box);
                });
            }

            /**
             * 循环扫描视频帧
             */
            async function scanFrame() {
                if (video.readyState < video.HAVE_CURRENT_DATA) {
                    return; 
                }
                
                try {
                    // 注意：这里我们不再需要 codeReader.decodeMultipleFromVideoElement(video)
                    // 最新版本中，推荐使用 codeReader.decodeFromVideoElement(video) 
                    // 并配合一个循环来获取多个结果，但 decodeMultiple 仍然可用
                    const results = await codeReader.decodeMultipleFromVideoElement(video);
                    drawOverlays(results);
                    
                } catch (err) {
                    if (err instanceof NotFoundException) {
                        drawOverlays([]); 
                    } else {
                        // 忽略其他错误，继续扫描
                    }
                }
            }

            /**
             * 启动摄像头
             */
            async function startCamera() {
                try {
                    const constraints = {
                        video: { 
                            facingMode: 'environment' 
                        },
                        audio: false
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    
                    video.onplaying = () => {
                        statusEl.textContent = '摄像头已启动，请对准二维码。';
                        setInterval(scanFrame, 300); // 每 300ms 扫一次
                    };

                } catch (err) {
                    console.error("摄像头启动失败:", err);
                    if (err.name === 'NotAllowedError') {
                        statusEl.textContent = '错误：用户拒绝了摄像头权限。';
                    } else if (err.name === 'NotFoundError' || err.name === 'OverconstrainedError') {
                        statusEl.textContent = '错误：找不到后置摄像头。';
                    } else {
                        statusEl.textContent = `错误：摄像头启动失败 (${err.message})。`;
                    }
                }
            }

            startCamera();

        });
    </script>
</body>
</html>

